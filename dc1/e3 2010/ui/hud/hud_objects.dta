(PanelDir
   (types
      (hud
         (editor
            (cur_hud
               object
               (class RndDir)
               (obj_flags allow_null)
               (help "Currently selected hud")
            )
            (move
               symbol
               (list
                  {do
                     ($dir {{milo cur_dir} find moves 0})
                     ($list {array 0})
                     {if_else $dir
                        {$dir iterate HamMove $move {push_back $list {symbol {$move name}}}}
                        {push_back $list ''}
                     }
                     $list
                  }
               )
               (interp_handlers update_move)
               (propanim_safetoadd update_move_keys)
               (help "current move changed by the song.anim")
            )
            (toggle_speed
               script
               (script
                  {if midi_player
                     {midi_player set active 1}
                  }
                  {$this set_slow {! [slow_speed]} 1}
               )
               (help "Tests the speed animation")
            )
            (toggle_barking
               script
               (script
                  {if {&& action_bark_player master}
                     {do
                        ($was_active {action_bark_player get active})
                        {action_bark_player set_active 0}
                        {if {! $was_active}
                           {$this add_all_barks}
                        }
                     }
                  }
               )
            )
            (freestyle_movement float (range 0 1))
         )
         (cur_hud "")
         (move '')
         (cur_move_index -1)
         (has_loop 0)
         (loop_start 0)
         (loop_end 0)
         (moves_dir "")
         (loop_wrapping 1)
         (special_move_list ())
         (slow_speed 0)
         (freestyle_movement 0)
         (show_photo_tags 1)
         (force_longest_sfx 0)
         (enter
            {set $hud_panel $this}
            {set [move] "rest.move"}
            {set [cur_move_index] -1}
            {if {&& $hamdirector {$hamdirector get_world}}
               {set [moves_dir]
                  {{$hamdirector get_world} find moves 0}
               }
               {{$hamdirector get_world} add_sink $this (skills_review)}
            }
            {if {exists master}
               {master add_sink
                  $this
                  (downbeat beat halfbeat quarterbeat first_beat)
               }
            }
            {do
               ($final_pose_obj {find_obj [moves_dir] final_pose})
               {if $final_pose_obj
                  {$final_pose_obj activate}
               }
               {if {&& $edit_mode {exists final_pose_parser}}
                  {final_pose_parser add_sink $this ((final_pose final_pose_snapshot))}
               }
            }
            {if {== [cur_hud] ""}
               {set [cur_hud]
                  {$this find "static_hud" 0}
               }
            }
         )
         (music_start
            {if {&& $edit_mode $hamdirector {$hamdirector get_world}}
               {handle ({$hamdirector get_world} beat_animation_start)}
            }
            kDataUnhandled
         )
         (music_end
            {if {&& $edit_mode $hamdirector {$hamdirector get_world}}
               {handle ({$hamdirector get_world} beat_animation_stop)}
            }
            kDataUnhandled
         )
         (skills_review
            {if [cur_hud]
               {[cur_hud] reset_beats}
            }
            kDataUnhandled
         )
         (set_score_multiplier
            ($mult)
            {if {!= {game_panel get_type} skillz}
               {do
                  ($mult_anim
                     {find_obj
                        {game_panel get star_display}
                        multiplier_meter
                        set_multiplier.anim
                     }
                  )
                  {if $mult_anim
                     {$mult_anim set_frame $mult}
                  }
               }
            }
         )
         (set_miss_streak_pct
            ($val)
            {do
               ($meter {$this find miss_streak.anim 0})
               {if $meter
                  {$meter animate (dest {'*' $val {$meter end_frame}})}
               }
            }
         )
         (set_num_photos
            ($num)
            {do
               ($photo_strip {$this find photo_booth_strip})
               ($photo_counter {$this find photo_award_counter 0})
               ($photo_fill {find_obj $this photo_award_counter award_fill.anim})
               ($photo)
               ($photo_active_anim)
               ($photo_star)
               {if $photo_counter
                  {foreach $i (2 3 4)
                     {set $photo_star {$photo_counter find {sprint "photo_award_star_0" $i}}}
                     {if_else {>= $num $i}
                        {$photo_star animate (dest {$photo_star end_frame})}
                        {$photo_star animate (range 0 0)}
                     }
                  }
                  {{$photo_counter find photo_count.lbl} set_int $num}
               }
               {set [show_photo_tags] {< $num 4}}
               {if {! [show_photo_tags]}
                  {foreach $flash_card {[cur_hud] get (flash_cards)}
                     {if {> {$flash_card get beat} $beat}
                        {$flash_card set_tagged 0}
                     }
                  }
               }
               {$photo_fill set_frame {'*' 2 {'*' $num 480}}}
            }
         )
         (take_snapshot
            {do
               ($photo_fill {find_obj $this photo_award_counter award_fill.anim})
               {$photo_fill animate (dest 0)}
               {if gesture_mgr
                  {ui take_snapshot}
                  {meta_performer freestyle_picture_taken}
                  {do
                     ($num_snapshots {gesture_mgr num_snapshots})
                     ($photo_mat)
                     {if {> $num_snapshots 0}
                        {set $photo_mat
                           {find_obj $this photo_display {sprintf "photo_%02d.mat" $num_snapshots}}
                        }
                        {if_else $photo_mat
                           {$photo_mat set
                              diffuse_tex
                              {gesture_mgr snapshot_tex {- $num_snapshots 1}}
                           }
                           {notify "No photo objects found. Too many photos taken."}
                        }
                     }
                  }
               }
            }
         )
         (show_snapshots
            ($visible $count)
            {do
               ($cycle_photos
                  {find_obj
                     $this
                     photo_display
                     {sprintf "display%02d.anim" {int {round {/ $count 4}}}}
                  }
               )
               ($photo_show_anim {find_obj $this display_photos.anim})
               {if {&& $cycle_photos {>= $count 0}}
                  {$cycle_photos animate (loop 0 {$cycle_photos end_frame})}
               }
               {if $photo_show_anim
                  {$photo_show_anim animate
                     (dest
                        {if_else $visible
                           {$photo_show_anim end_frame}
                           0
                        }
                     )
                  }
               }
            }
         )
         (final_pose_snapshot
            {handle (ui take_snapshot 3)}
            {do
               ($num_snapshots
                  {if_else {exists gesture_mgr}
                     {gesture_mgr num_snapshots}
                     1
                  }
               )
               ($tex
                  {if_else {exists gesture_mgr}
                     {gesture_mgr snapshot_tex {- $num_snapshots 1}}
                     ""
                  }
               )
               ($final_pose_display {find_obj $this final_pose_display})
               ($photo_mat {find_obj $final_pose_display photo.mat})
               {if {&& $final_pose_display $photo_mat}
                  {$photo_mat set diffuse_tex $tex}
                  {if $edit_mode
                     {handle ({$hamdirector get_world} final_pose_perfect)}
                  }
               }
            }
         )
         (update_move_keys
            ($safe)
            {if {&& $safe $hamdirector {$hamdirector get_world}}
               {do
                  ($song_anim {$hamdirector song_anim})
                  ($frame_measure 0)
                  {$song_anim foreach_keyframe $hamdirector
                     (move)
                     $frame
                     $value
                     {set $frame_measure {/ {seconds_to_beat {/ $frame 30}} 4}}
                     {$song_anim replace_frame
                        {'*' 30 {beat_to_seconds {'*' 4 {round $frame_measure}}}}
                     }
                  }
               }
            }
         )
         (update_loop
            {if {exists game}
               {do
                  ($s)
                  ($e)
                  {set [has_loop]
                     {audio get_loop_beats $s $e}
                  }
                  {set [loop_start] $s}
                  {set [loop_end] $e}
               }
            }
         )
         (get_move
            ($name)
            {if {&& {! [moves_dir]} $hamdirector {$hamdirector get_world}}
               {set [moves_dir] {{$hamdirector get_world} find moves}}
            }
            {if_else [moves_dir]
               {do
                  ($retVal)
                  {set $retVal {[moves_dir] find $name}}
                  {if {&& {! $retVal} {!= $name "rest.move"} {!= $name ""}}
                     {notify_once "WARNING: No move called " $name ". Found in authoring."}
                  }
                  $retVal
               }
               ""
            }
         )
         (is_special_move
            ($index)
            {find_elem [special_move_list] $index}
         )
         (move_from_beat
            ($b)
            {do
               ($move)
               ($practice_start)
               ($practice_end)
               {if_else
                  {&&
                     {$hamdirector practice_beats $practice_start $practice_end}
                     {'||' {< {int $b} {int $practice_start}} {>= {int $b} {int $practice_end}}}
                  }
                  {$this get_move "rest.move"}
                  {do
                     {if {== {mod {int $b} 4} 0}
                        {'+=' $b 1}
                     }
                     {$this get_move {$hamdirector beat_to_movename $b}}
                  }
               }
            }
         )
         (beat_from_move_index
            ($index)
            {if_else {&& $hamdirector {$hamdirector song_anim}}
               {seconds_to_beat
                  {/
                     {{$hamdirector song_anim} frame_from_index $hamdirector (move) $index}
                     30
                  }
               }
               -1
            }
         )
         (wrap_beat_to_loop
            ($beat)
            {if_else {'||' {< $beat [loop_start]} {> $beat [loop_end]}}
               {if_else {< $beat [loop_start]}
                  {'+' $beat {- [loop_end] [loop_start]}}
                  {- $beat {- [loop_end] [loop_start]}}
               }
               $beat
            }
         )
         (move_interp
            ($a $b $r)
            {if {&& $hamdirector {$hamdirector get_world}}
               {do
                  ($song_anim {$hamdirector song_anim})
                  ($beat {seconds_to_beat {/ {$song_anim frame} 30}})
                  ($cur_index
                     {$song_anim index_from_frame $hamdirector (move) {$song_anim frame}}
                  )
                  ($now {$this move_from_beat $beat})
                  ($start)
                  ($end)
                  {if {'||' {!= $a [move]} {!= $cur_index [cur_move_index]}}
                     {if {exists game}
                        {game set move $now}
                     }
                     {set [cur_move_index] $cur_index}
                     {set [move]
                        {if_else $now
                           {$now name}
                           ''
                        }
                     }
                     {if {&& $now {! {$now is_rest}}}
                        {[cur_hud] do_now_effect}
                     }
                     {$this update_loop}
                     {do
                        ($flash_card_count {size {[cur_hud] get (flash_cards)}})
                        ($num_look_aheads
                           {- {- $flash_card_count {[cur_hud] get num_look_behinds}} 1}
                        )
                        ($flash_card_beat {'+' $beat {'*' 4 $num_look_aheads}})
                        ($measure {int {/ $flash_card_beat 4}})
                        ($my_beat)
                        ($flash_card_measure)
                        ($flash_card)
                        ($i 0)
                        {foreach $flash_card {[cur_hud] get (flash_cards)}
                           {set $flash_card_measure
                              {'+'
                                 $i
                                 {'*' $flash_card_count {int {/ {- $measure $i} $flash_card_count}}}
                              }
                           }
                           {set $my_beat {'*' 4 $flash_card_measure}}
                           {if {&& [has_loop] [loop_wrapping] {>= $beat [loop_start]}}
                              {set $my_beat {$this wrap_beat_to_loop $my_beat}}
                           }
                           {if {!= $my_beat {$flash_card get beat}}
                              {$flash_card set beat $my_beat}
                              {$flash_card set_move {$this move_from_beat $my_beat}}
                              {if_else [show_photo_tags]
                                 {$flash_card set_tagged {$this is_special_move {int {/ $my_beat 4}}}}
                                 {$flash_card set_tagged 0}
                              }
                           }
                           {'++' $i}
                        }
                     }
                  }
                  {[cur_hud] set_anim_frame $beat}
               }
            }
         )
         (reset
            {[cur_hud] reset}
            {handle (reset.trig trigger)}
            {$this set_slow 0 0}
            {if {&& $edit_mode {exists active_events_parser}}
               {active_events_parser add_sink $this () 3}
            }
         )
         (set_score
            ($score $old_score $best_possible $player_idx)
            {do
               ($boombox_score
                  {if_else $hamdirector
                     {find_obj
                        {$hamdirector get cur_world}
                        score
                        {sprint "score_player_" $player_idx ".lbl"}
                     }
                     ""
                  }
               )
               ($race_arrow
                  {find_obj
                     $this
                     multiplayer_meter
                     {sprint "arrow_" $player_idx ".anim"}
                  }
               )
               {if $boombox_score
                  {$boombox_score start_count $old_score $score 500 score_fmt}
               }
               {if $race_arrow
                  {do
                     ($pct
                        {if_else {== $best_possible 0}
                           0
                           {/ $score $best_possible}
                        }
                     )
                     {$race_arrow animate
                        (dest {'*' $pct {$race_arrow end_frame}})
                        (period 0.2)
                     }
                  }
               }
            }
         )
         (set_ghost_score
            ($score $best_possible)
            {do
               ($ghost_arrow {find_obj $this multiplayer_meter arrow_1_ghost.anim})
               {if $ghost_arrow
                  {do
                     ($pct
                        {if_else {== $best_possible 0}
                           0
                           {/ $score $best_possible}
                        }
                     )
                     {$ghost_arrow animate
                        (dest {'*' $pct {$ghost_arrow end_frame}})
                        (period 0.2)
                     }
                  }
               }
            }
         )
         (set_review_percentage
            ($percentage)
            {do
               ($timeline {$this find static_hud})
               ($result_label {$this find skills_review_results.lbl})
               {{$timeline find review_percentage.lbl} set_token_fmt
                  percentage
                  {int $percentage}
               }
               {{$timeline find review_percentage_changed.trig} trigger}
               {$result_label set_token_fmt percentage {int $percentage}}
            }
         )
         (get_seq
            ($seq)
            {if {!= {type $seq} 4}
               {set $seq
                  {find_obj $this sound_bank {sprint $seq ".cue"}}
               }
            }
            $seq
         )
         (play
            ($seq)
            {set $seq {$this get_seq $seq}}
            {if_else $seq
               {$seq play}
               {notify "could not play " $seq}
            }
         )
         (get_seq_length
            ($seq)
            {set $seq {$this get_seq $seq}}
            {if_else $seq
               {switch {$seq class_name}
                  (RandomGroupSeq
                     {if_else {$seq size (children)}
                        {$this get_seq_length
                           {$seq get
                              (children {mod {$seq get_next_play_index} {$seq size (children)}})
                           }
                        }
                        0
                     }
                  )
                  (Sfx
                     {do
                        ($length 0)
                        ($samp_length 0)
                        {foreach_int $i 0 {$seq size (sfxmaps)}
                           {set $samp_length {{$seq get (sfxmaps $i sample)} sample_length}}
                           {if {> $samp_length $length}
                              {set $length $samp_length}
                           }
                        }
                        $length
                     }
                  )
               }
               0
            }
         )
         (get_longest_seq
            ($seq)
            {set $seq {$this get_seq $seq}}
            {if {== {$seq class_name} RandomGroupSeq}
               {do
                  ($longest 0)
                  ($child_length 0)
                  ($children {$seq get_array children})
                  {foreach $child $children
                     {set $child_length {$this get_seq_length $child}}
                     {if {> $child_length $longest}
                        {set $seq $child}
                        {set $longest $child_length}
                     }
                  }
               }
            }
            $seq
         )
         (pick_shorter_seq
            ($seq $highest_length)
            {set $seq {$this get_seq $seq}}
            {if {== {$seq class_name} RandomGroupSeq}
               {do
                  ($legal ())
                  ($children {$seq get_array children})
                  ($longest 0)
                  ($child_length)
                  ($longest_legal)
                  ($index 0)
                  {resize $legal 0}
                  {foreach $child $children
                     {set $child_length {$this get_seq_length $child}}
                     {if {<= $child_length $highest_length}
                        {push_back $legal $index}
                        {if {> $child_length $longest}
                           {set $longest_legal $index}
                           {set $longest $child_length}
                        }
                     }
                     {'++' $index}
                  }
                  {if {size $legal}
                     {if_else [force_longest_sfx]
                        {$seq force_next_play_index $longest_legal}
                        {$seq force_next_play_index {elem $legal {random_int 0 {size $legal}}}}
                     }
                  }
               }
            }
         )
         (toggle_force_longest_sfx
            {set [force_longest_sfx] {! [force_longest_sfx]}}
            {do
               ($sound_bank {find_obj $this sound_bank})
               {if $sound_bank
                  {$sound_bank iterate
                     RandomGroupSeq
                     $seq
                     {if_else [force_longest_sfx]
                        {do
                           ($children {$seq get_array children})
                           ($longest 0)
                           ($child_length)
                           ($longest_index)
                           ($index 0)
                           {foreach $child $children
                              {set $child_length {$this get_seq_length $child}}
                              {if {> $child_length $longest}
                                 {set $longest_index $index}
                                 {set $longest $child_length}
                              }
                              {'++' $index}
                           }
                           {$seq set force_choose_index $longest_index}
                        }
                        {$seq set force_choose_index -1}
                     }
                  }
               }
            }
         )
         (set_slow
            ($slow $fade)
            {set [slow_speed] $slow}
            {do
               ($fade_anim {sound_bank find skills_cross_fade.anim 0})
               ($dest_frame
                  {if_else {&& $fade_anim $slow}
                     {$fade_anim end_frame}
                     0
                  }
               )
               {if_else $fade
                  {$fade_anim animate (dest $dest_frame)}
                  {$fade_anim animate (range $dest_frame $dest_frame)}
               }
            }
            {if {&& $hamdirector {$hamdirector get_world}}
               {handle
                  ({$hamdirector get_world}
                     {if_else [slow_speed]
                        skills_slowdown_start
                        skills_slowdown_stop
                     }
                  )
               }
            }
         )
         (feedback_instruction
            ($text)
            {instructional_message.lbl set text_token $text}
            {instructional_message.anim animate}
         )
         (add_all_barks
            {if {&& action_bark_player master}
               {do
                  ($last_beat {seconds_to_beat {/ {master song_duration_ms} 1000}})
                  ($i 0)
                  {action_bark_player set_active 0}
                  {while {< $i $last_beat}
                     {action_bark_player add_barks {$this move_from_beat $i} (verb) $i}
                     {if [slow_speed]
                        {action_bark_player add_barks {$this move_from_beat $i} (verb_slow) $i}
                     }
                     {'+=' $i 4}
                  }
                  {action_bark_player set_active 1}
               }
            }
         )
      )
      (shell
         (editor
            (postprocess
               object
               (class PostProc)
               (help "Post process object to use when this panel is on screen")
               (post_sync {$this update_postproc})
            )
            (refresh_postproc
               script
               (script {$this update_postproc})
               (help "Refresh postprocessor selection on the tool")
            )
         )
         (postprocess '')
         (enter {$this update_postproc})
         (update_postproc
            {if_else [postprocess]
               {[postprocess] select}
               {rnd reset_postproc}
            }
         )
      )
      (shell_in_game
         (editor
            (postprocess
               object
               (class PostProc)
               (help "Post process object to use when this panel is on screen")
               (post_sync {$this update_postproc})
            )
            (refresh_postproc
               script
               (script {$this update_postproc})
               (help "Refresh postprocessor selection on the tool")
            )
         )
         (postprocess '')
         (enter {$this override_postproc [postprocess]})
         (override_postproc
            ($pp)
            {rnd set_postproc_override $pp}
         )
         (exit_complete {$this override_postproc ''})
         (update_postproc
            {if_else [postprocess]
               {[postprocess] select}
               {rnd reset_postproc}
            }
         )
      )
   )
)
(RndDir
   (types
      (4beatscrolling
         (measure_anim "")
         (flash_cards ())
         (flash_card_animations ())
         (num_look_behinds 1)
         (editor
            (measure_anim
               object
               (class Anim)
               (help "Animation to use on the measure")
            )
            (flash_cards
               (array object (class RndDir move_display))
               (help "Sequence of the flashcards starting with the lookbehind")
            )
            (flash_card_animations
               (array object (class PropAnim))
               (help "Sequence of the PropAnims which animate flashcards through the UI")
            )
            (num_look_behinds
               int
               (range 0 5)
               (help "How many of the flashcards in the list are 'look behinds'?")
            )
         )
         (reset {reset.trig trigger})
         (do_now_effect
            {do
               ($effect {find_obj $this now_sparkles.anim})
               {if $effect
                  {$effect animate}
               }
            }
         )
         (set_anim_frame
            ($beat)
            {do
               ($flash_card_count {size [flash_cards]})
               ($num_look_aheads {- {- $flash_card_count [num_look_behinds]} 1})
               ($flash_card_beat {'+' $beat {'*' 4 $num_look_aheads}})
               ($measure {/ $flash_card_beat 4})
               ($flash_card_measure)
               ($anim)
               ($i 0)
               {foreach $anim [flash_card_animations]
                  {set $flash_card_measure
                     {if_else {> $i $measure}
                        0
                        {mod {- $measure $i} $flash_card_count}
                     }
                  }
                  {$anim set_frame {'*' {'*' 4 480} $flash_card_measure}}
                  {'++' $i}
               }
            }
         )
         (reset_beats
            {foreach $elem [flash_cards]
               {$elem set beat -10}
            }
         )
      )
      (move_display
         (beat_anim "")
         (cur_move "")
         (tagged 0)
         (beat -10)
         (active 0)
         (beat_frame 0)
         (use_small_tex 0)
         (editor
            (reset script (script {$this reset}))
            (tagged
               bool
               (help "Tells us if this move is tagged for photo opportunity")
               (post_sync {$this set_tagged [tagged]})
            )
            (active
               bool
               (post_sync {$this activate [active]})
               (help "Test for activation of the flashcard")
            )
            (beat_anim
               object
               (class Anim)
               (help "Animation to play along with the beat")
            )
            (beat_frame
               float
               (interp_handlers set_beat_frame)
               (help "Frame of animation for the beat animation")
            )
            (use_small_tex
               bool
               (interp_handlers set_use_small_tex)
               (help "Use the small texture \\" '_sm.tex\\"' 'instead."')
            )
         )
         (reset
            {if {$this find activate.anim 0}
               {activate.anim set_frame 0}
            }
            {reset.trig trigger}
            {$this move_to $this 0}
            {set [beat] -10}
         )
         (set_use_small_tex
            ($value)
            {set [use_small_tex] $value}
            {if {!= [cur_move] ""}
               {icon.mat set
                  diffuse_tex
                  {[cur_move] get
                     {if_else [use_small_tex]
                        small_tex
                        tex
                     }
                  }
               }
            }
         )
         (set_beat_frame
            ($a $b $r)
            {if [beat_anim]
               {[beat_anim] set_frame {'*' {'*' 4 480} {'+' $a {'*' $r {- $b $a}}}}}
            }
         )
         (set_move
            ($move)
            {set [cur_move] $move}
            {if_else {!= [cur_move] ""}
               {do
                  ($tex
                     {$move get
                        {if_else [use_small_tex]
                           small_tex
                           tex
                        }
                     }
                  )
                  ($ratio 1)
                  ($x_scale)
                  ($y_scale)
                  ($z_scale)
                  {icon.mat set diffuse_tex $tex}
                  {icon_state.anim set_frame {[cur_move] get tex_state}}
                  {if $tex
                     {set $ratio {/ {$tex get width} {$tex get height}}}
                  }
                  {icon.mesh get_local_scale $x_scale $y_scale $z_scale}
                  {icon.mesh set_local_scale {'*' $z_scale $ratio} $y_scale $z_scale}
                  {if {&& $edit_mode {!= {move_name.lbl get edit_text} ""}}
                     {move_name.lbl set edit_text ""}
                  }
                  {move_name.lbl set_move_name $move}
                  {icon.grp set_showing {!= $tex ""}}
               }
               {do
                  ($icon_state {$this find icon_state.anim 0})
                  {icon.mat set diffuse_tex ""}
                  {move_name.lbl set_move_name ""}
                  {if $icon_state
                     {$icon_state set_frame 0}
                  }
                  {icon.grp set_showing 0}
               }
            }
         )
         (set_tagged
            ($val)
            {set [tagged] $val}
            {do
               ($tag_anim {$this find tag.anim 0})
               {if $tag_anim
                  {$tag_anim set_frame
                     {if_else [tagged]
                        1
                        0
                     }
                  }
               }
            }
         )
         (activate
            ($active)
            {do
               ($active_anim {$this find activate.anim 0})
               ($end_frame 0)
               ($anim_time 0)
               {if $active_anim
                  {set $end_frame {$active_anim end_frame}}
                  {set $anim_time {/ $end_frame 30}}
                  {$active_anim animate
                     (dest
                        {if_else $active
                           $end_frame
                           0
                        }
                     )
                  }
               }
               {if {! $active}
                  {$this move_to $this 1}
               }
               {if $active
                  {$this set_award 0 0 0}
               }
            }
         )
         (set_award
            ($award $play $persistent)
            {do
               ($award_display
                  {$this find
                     {if_else $persistent
                        persistent_award
                        current_award
                     }
                  }
               )
               ($award_select_anim {$award_display find setup.anim 0})
               ($effect_anim {find_obj $award_display effect.anim})
               {if $award_select_anim
                  {$award_select_anim set_frame $award}
               }
               {if $effect_anim
                  {$effect_anim animate
                     (range
                        {if_else $play
                           0
                           {$effect_anim end_frame}
                        }
                        {$effect_anim end_frame}
                     )
                  }
               }
            }
         )
         (replay_effect
            {do
               ($anim {find_obj $this persistent_award effect.anim})
               {if {&& $anim {> {$anim frame} 0}}
                  {$anim animate}
               }
            }
         )
         (set_award_fade
            ($fade)
            {do
               ($award_display {$this find persistent_award})
               ($fade_anim {$award_display find fade_setup.anim 0})
               {if $fade_anim
                  {do
                     ($frame
                        {if_else $fade
                           1.0
                           0.0
                        }
                     )
                     {$fade_anim set_frame $frame}
                  }
               }
            }
         )
         (move_to
            ($location_trans $animate)
            {if {&& {$this exists move_to.anim} {$this exists flash_card.grp}}
               {do
                  ($end {move_to.anim end_frame})
                  {flash_card.grp set_trans_parent $location_trans 1}
                  {move_to.anim stop_animation}
                  {if_else {! $animate}
                     {do
                        {flash_card.grp set_local_rot_mat 1 0 0 0 1 0 0 0 1}
                        {flash_card.grp set_local_pos 0 0 0}
                     }
                     {do
                        {move_to.anim set_key flash_card.grp (scale) 0}
                        {move_to.anim set_key flash_card.grp (rotation) 0}
                        {move_to.anim set_key flash_card.grp (position) 0}
                        {if_else {== $location_trans $this}
                           {do
                              {move_to.anim set_key_val flash_card.grp (scale) 480 (1 1 1) 1}
                              {move_to.anim set_key_val
                                 flash_card.grp
                                 (rotation)
                                 480
                                 (0 0 0 0)
                                 1
                              }
                              {move_to.anim set_key_val flash_card.grp (position) 480 (0 0 0) 1}
                           }
                           {do
                              {move_to.anim set_key flash_card.grp (scale) 480}
                              {move_to.anim set_key flash_card.grp (rotation) 480}
                              {move_to.anim set_key flash_card.grp (position) 480}
                           }
                        }
                        {move_to.anim animate}
                     }
                  }
               }
            }
         )
         (set_num_links
            ($count)
            {if {$this exists link_bracket.anim}
               {link_bracket.anim set_frame $count}
            }
         )
      )
      (multiplier_meter
         (editor
            (channel1_anim
               object
               (class Anim)
               (help "animation to set_frame channel1 from narrator audio")
            )
            (channel2_anim
               object
               (class Anim)
               (help "animation to set_frame channel2 from narrator audio")
            )
            (average_anim
               object
               (class Anim)
               (help "animation to set_frame average of channel1 and channel2")
            )
            (multiply_anim
               object
               (class Anim)
               (help "animation to set_frame multiplication of channel1 and channel2")
            )
         )
         (channel1_anim "")
         (channel2_anim "")
         (average_anim "")
         (multiply_anim "")
         (channel_data
            ($ch1 $ch2)
            {if [channel1_anim]
               {[channel1_anim] set_frame $ch1}
            }
            {if [channel2_anim]
               {[channel2_anim] set_frame $ch2}
            }
            {if [average_anim]
               {[average_anim] set_frame {/ {'+' $ch1 $ch2} 2}}
            }
            {if [multiply_anim]
               {[multiply_anim] set_frame {'*' $ch1 $ch2}}
            }
         )
         (enter
            {if {&& $hamdirector {$hamdirector get_world}}
               {do
                  ($fx
                     {find_obj {$hamdirector get_world} hud sound_bank narrator_monitor.effmon}
                  )
                  {$fx add_sink $this (channel_data)}
               }
            }
            {$this channel_data 0 0}
            {foreach_int $i 0 5
               {do
                  ($mult_label {sprint $i ".lbl"})
                  ($lbl {find_obj $this $mult_label})
                  {if $lbl
                     {$lbl set_int $i}
                  }
               }
            }
         )
      )
      (player_feedback
         (rating_frac 0)
         (rating move_bad)
         (desired_period_beats 1)
         (first_perfect_frame 1920)
         (editor
            (rating_frac
               float
               (post_sync {$this set_rating_frac [rating_frac] [desired_period_beats]})
            )
            (rating
               symbol
               (list (FEEDBACK_STATES))
               (post_sync
                  {$this set_rating_frac
                     {rating_to_rating_frac [rating]}
                     [desired_period_beats]
                  }
               )
            )
            (desired_period_beats float)
            (first_perfect_frame float)
         )
         (enter {$this set_rating_frac 0 -1})
         (set_rating_frac
            ($frac $beats_remaining)
            {do
               ($desired_frame
                  {if_else {== $frac 1}
                     {phrase_meter.anim end_frame}
                     {'*' $frac {- [first_perfect_frame] {phrase_meter.anim start_frame}}}
                  }
               )
               {phrase_meter.anim stop_animation}
               {if_else {< $beats_remaining 0}
                  {phrase_meter.anim set_frame $desired_frame}
                  {phrase_meter.anim animate
                     (dest $desired_frame)
                     (period {min [desired_period_beats] $beats_remaining})
                  }
               }
            }
         )
      )
      (score_star_display
         (editor
            (stars
               (array object (class RndDir))
               (help "Stars in the list")
            )
            (cur_star
               int
               (range 0 {'+' {size [stars]} 1})
               (help "Current selected star for testing")
            )
            (star_progress
               float
               (range 0 1)
               (post_sync {$this set_star_progress [cur_star] [star_progress]})
               (help "Star progress for testing")
            )
            (star_complete script (script {$this set_star_complete [cur_star]}))
            (reset script (script {$this reset}))
         )
         (stars ())
         (cur_star 0)
         (star_progress 0)
         (set_star_progress
            ($index $progress)
            {if {< $index {size [stars]}}
               {do
                  ($anim {{elem [stars] $index} find "score.anim" 0})
                  {if $anim
                     {$anim set_frame {'*' $progress {$anim end_frame}}}
                  }
               }
            }
         )
         (set_star_complete
            ($index)
            {if_else {< $index {size [stars]}}
               {do
                  ($anim {{elem [stars] $index} find "award.anim" 0})
                  {if $anim
                     {$anim animate}
                  }
                  {$this set_star_progress $index 1}
               }
               {do
                  ($final_star_trig "")
                  {foreach $star [stars]
                     {set $final_star_trig {find_obj $star "final_star.trig"}}
                     {if $final_star_trig
                        {$final_star_trig trigger}
                     }
                  }
               }
            }
         )
      )
      (skills_timeline
         (editor
            (flash_cards
               (array object (class RndDir))
               (help "All the flash cards we have to use")
            )
            (num_moves
               int
               (range 0 {size [flash_cards]})
               (post_sync {$this set_num_moves [num_moves]})
            )
            (deactivate script (script {$this deactivate}))
            (introduce_1 script (script {$this test_introduce 1}))
            (introduce_2 script (script {$this test_introduce 2}))
            (introduce_3 script (script {$this test_introduce 3}))
            (introduce_4 script (script {$this test_introduce 4}))
         )
         (flash_cards ())
         (num_moves 1)
         (set_num_moves
            ($num_moves)
            {do
               ($setup_anim {$this find setup.anim 0})
               {set [num_moves] $num_moves}
               {if $setup_anim
                  {$setup_anim set_frame [num_moves]}
               }
               {foreach_int $i 0 {size [flash_cards]}
                  {{elem [flash_cards] $i} set_showing {< $i [num_moves]}}
               }
            }
         )
         (clear_moves
            {foreach $flashcard [flash_cards]
               {$flashcard reset}
            }
            {$this set_num_moves 0}
            {$this deactivate}
            {if {$this exists reset.trig}
               {reset.trig trigger}
            }
         )
         (add_move
            ($move $beat)
            {if {&& $move {< [num_moves] {- {size [flash_cards]} 1}}}
               {do
                  ($flash_card {elem [flash_cards] [num_moves]})
                  {$flash_card set_move $move}
                  {$flash_card set beat $beat}
                  {$this set_num_moves {'+' [num_moves] 1}}
               }
            }
         )
         (deactivate
            {$this show_tick_meter 0}
            {foreach $flashcard [flash_cards]
               {$flashcard activate 0}
            }
         )
         (find_flashcard
            ($beat)
            {do
               ($found "")
               {foreach_int $i 0 [num_moves]
                  {do
                     ($flash_card {elem [flash_cards] $i})
                     {if {== $beat {$flash_card get beat}}
                        {set $found $flash_card}
                     }
                  }
               }
               $found
            }
         )
         (set_active
            ($beat $activate)
            {do
               ($flash_card {$this find_flashcard $beat})
               {if $flash_card
                  {$flash_card activate $activate}
               }
            }
         )
         (award
            ($index)
            {if {$this exists skillz_gate_meter}
               {{skillz_gate_meter
                     find
                     {sprint
                        "tick_"
                        $index
                        "_fire.anim"}} animate

               }
            }
         )
         (set_move_award
            ($beat $award $play $persistent)
            {do
               ($flash_card {$this find_flashcard $beat})
               {if $flash_card
                  {$flash_card set_award $award $play $persistent}
               }
            }
         )
         (highlight_awards
            {foreach $flash_card [flash_cards]
               {$flash_card replay_effect}
            }
         )
         (set_move_award_fade
            ($beat $fade)
            {do
               ($flash_card {$this find_flashcard $beat})
               {if $flash_card
                  {$flash_card set_award_fade $fade}
               }
            }
         )
         (introduce
            ($flashcard_beat $index $total)
            {do
               ($flash_card {$this find_flashcard $flashcard_beat})
               ($trans
                  {$this find
                     {sprint "introduce_" $total "_move_" {'+' $index 1} ".trans"}
                     0
                  }
               )
               {if {&& $flash_card $trans}
                  {$flash_card move_to $trans 1}
               }
            }
         )
         (show_tick_meter
            ($show)
            {if {&& $show {$this exists skillz_gate_meter}}
               {{skillz_gate_meter find reset.trig} trigger}
            }
            {if {$this exists show_meter.anim}
               {show_meter.anim animate
                  (dest
                     {if_else $show
                        {show_meter.anim end_frame}
                        0
                     }
                  )
               }
            }
         )
         (test_introduce
            ($count)
            {foreach_int $i 0 $count
               {do
                  ($flash_card {elem [flash_cards] $i})
                  ($trans
                     {$this find
                        {sprint "introduce_" $count "_move_" {'+' $i 1} ".trans"}
                        0
                     }
                  )
                  {if $trans
                     {$flash_card move_to $trans 1}
                  }
                  {$flash_card activate 1}
               }
            }
         )
      )
   )
)
(Object
   (types
      (music_speed_controller
         (speed 1.0)
         (editor
            (speed
               float
               (range 0 1.0)
               (interp_handlers update_speed)
               (help "Animates the song speed")
            )
         )
         (update_speed
            ($a $b $r)
            {if {exists audio}
               {audio set speed {'+' $a {'*' $r {- $b $a}}}}
            }
         )
      )
      (final_pose
         (beat -1.0)
         (activate)
         (editor
            (beat float (help "beat at which the final pose occurs"))
            (set_beat
               script
               (script
                  {if $tool_song
                     {set [beat] {seconds_to_beat {$tool_song frame}}}
                     {milo update_open_editor $this}
                     {$this activate}
                  }
               )
            )
         )
      )
   )
)